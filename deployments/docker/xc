#!/bin/bash
#
# xc - x-extract CLI wrapper for Docker mode
#
# Usage:
#   xc add [url]          Add a download task
#   xc list               List all downloads
#   xc stats              Show download statistics
#   xc get [id]           Get download details
#   xc cancel [id]        Cancel a download
#   xc retry [id]         Retry a failed download
#   xc logs [id]          View download logs
#
# Examples:
#   xc add https://x.com/user/status/1234567890
#   xc list --status queued
#   xc logs abc12345
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COMPOSE_DIR="${SCRIPT_DIR}"

# Fallback to current directory if not in docker-compose directory
if [ ! -f "${COMPOSE_DIR}/docker-compose.yml" ]; then
    COMPOSE_DIR="$(pwd)"
fi

# Detect container name/service
CONTAINER_NAME="${CONTAINER_NAME:-x-extract}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    cat << 'EOF'
xc - x-extract CLI wrapper for Docker mode

Usage:
  xc add [url]          Add a download task
  xc list               List all downloads
  xc stats              Show download statistics
  xc get [id]           Get download details
  xc cancel [id]        Cancel a download
  xc retry [id]         Retry a failed download
  xc logs [id]          View download logs

Examples:
  xc add https://x.com/user/status/1234567890
  xc list --status queued
  xc logs abc12345
EOF
}

run_in_container() {
    docker exec "$CONTAINER_NAME" /app/bin/x-extract-cli --no-auto-start --server "http://localhost:8080" "$@"
}

run_via_docker_compose() {
    cd "$COMPOSE_DIR"
    docker-compose exec -T "$CONTAINER_NAME" /app/bin/x-extract-cli --no-auto-start --server "http://localhost:8080" "$@"
}

# Main command handling
case "${1:-}" in
    -h|--help|"")
        show_help
        exit 0
        ;;
    add|list|stats|get|cancel|retry|logs)
        COMMAND="$1"
        shift

        # Check if container is running
        if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^${CONTAINER_NAME}$"; then
            run_in_container "$COMMAND" "$@"
        elif command -v docker-compose &>/dev/null && [ -f "${COMPOSE_DIR}/docker-compose.yml" ]; then
            # Try docker-compose exec
            cd "$COMPOSE_DIR"
            if docker-compose ps --services --filter "status=running" 2>/dev/null | grep -q "$CONTAINER_NAME"; then
                run_via_docker_compose "$COMMAND" "$@"
            else
                echo -e "${YELLOW}Container not running. Starting...${NC}"
                docker-compose up -d
                sleep 3
                run_via_docker_compose "$COMMAND" "$@"
            fi
        else
            echo -e "${RED}Error: Cannot find x-extract container.${NC}"
            echo "Make sure Docker is running and x-extract is started."
            exit 1
        fi
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'xc --help' for usage information."
        exit 1
        ;;
esac
